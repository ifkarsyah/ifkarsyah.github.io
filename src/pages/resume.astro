---
import BaseLayout from '../layouts/BaseLayout.astro';
import ExperienceItem from '../components/ExperienceItem.astro';
import experiences from '../data/experiences.json';
import achievements from '../data/achievements.json';

const workExperiences = experiences.filter((exp: any) => exp.type === 'work');
const educationExperiences = experiences.filter((exp: any) => exp.type === 'education');

// Group work experiences by company, preserving insertion order
const companyGroups: { company: string; roles: any[]; startDate: string; endDate: string | null }[] = [];
for (const exp of workExperiences) {
  const group = companyGroups.find(g => g.company === exp.company);
  if (group) {
    group.roles.push(exp);
  } else {
    companyGroups.push({ company: exp.company, roles: [exp], startDate: exp.startDate, endDate: exp.endDate });
  }
}
// Compute overall date span per company
for (const group of companyGroups) {
  const allStarts = group.roles.map((r: any) => r.startDate).sort();
  const allEnds = group.roles.map((r: any) => r.endDate);
  group.startDate = allStarts[0];
  group.endDate = allEnds.includes(null) ? null : [...allEnds].sort().reverse()[0];
}

function formatDate(dateStr: string) {
  const [year, month] = dateStr.split('-');
  return new Date(Number(year), Number(month) - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
}
---

<BaseLayout pageTitle="Resume" description="My work experience and education history.">
  <div class="page-header">
    <div>
      <h1>Resume</h1>
      <p>My professional journey and educational background.</p>
    </div>
    <a href="/Ferdian_Ifkarsyah___Resume___2025___11____DE.pdf" download class="btn btn-outline">Download Resume</a>
  </div>

  <section class="experience-section">
    <h2 class="section-title">Work Experience</h2>
    <div class="timeline">
      {companyGroups.map((group) => (
        <div class="timeline-item type-work">
          <div class="timeline-dot"></div>
          <div class="timeline-content company-group">
            <div class="company-group-header">
              <div>
                <h3 class="company-group-name">{group.company}</h3>
                {group.roles[0].tagline && <p class="timeline-tagline">{group.roles[0].tagline}</p>}
                <span class="company-group-tenure">
                  {formatDate(group.startDate)} – {group.endDate ? formatDate(group.endDate) : 'Present'}
                </span>
              </div>
            </div>
            <div class="roles-list">
              {group.roles.map((role: any, i: number) => (
                <div class="role-item">
                  {i > 0 && (
                    <div class="promotion-bridge">
                      <span class="promotion-arrow">↑</span>
                      <span class="promotion-label">promoted</span>
                    </div>
                  )}
                  <div class="role-header">
                    <h4 class="role-title">{role.title}</h4>
                    <span class="role-date">
                      {formatDate(role.startDate)} – {role.endDate ? formatDate(role.endDate) : 'Present'}
                    </span>
                  </div>
                  <p class="timeline-description">{role.description}</p>
                  {role.bullets.length > 0 && (
                    <ul class="timeline-bullets">
                      {role.bullets.map((b: string) => <li>{b}</li>)}
                    </ul>
                  )}
                  {role.tags.length > 0 && (
                    <div class="tags">
                      {role.tags.map((tag: string) => <span class="tag">{tag}</span>)}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <section class="experience-section">
    <h2 class="section-title">Education</h2>
    <div class="timeline">
      {educationExperiences.map((exp: any) => (
        <ExperienceItem
          title={exp.title}
          company={exp.company}
          type={exp.type}
          startDate={exp.startDate}
          endDate={exp.endDate}
          description={exp.description}
          bullets={exp.bullets}
          tags={exp.tags}
        />
      ))}
    </div>
  </section>

  <section class="experience-section">
    <h2 class="section-title">Achievements</h2>
    <div class="achievements-list">
      {achievements.map((item: any) => (
        <div class="achievement-item">
          <span class="achievement-scope">{item.scope}</span>
          <div>
            <p class="achievement-title">{item.title}</p>
            <p class="achievement-desc">{item.description}</p>
          </div>
        </div>
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  .page-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .experience-section {
    margin-bottom: 3rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #2d3748);
  }

  .achievements-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .achievement-item {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
  }

  .achievement-scope {
    flex-shrink: 0;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--accent);
    background: rgba(0, 217, 255, 0.1);
    border: 1px solid rgba(0, 217, 255, 0.25);
    border-radius: 4px;
    padding: 0.2rem 0.5rem;
    margin-top: 0.15rem;
    white-space: nowrap;
  }

  .achievement-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .achievement-desc {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin: 0;
  }
</style>
