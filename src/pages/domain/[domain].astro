---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import BlogCard from '../../components/BlogCard.astro';

export async function getStaticPaths() {
  const projectFiles = import.meta.glob('../../content/projects/*.md', { eager: true });
  const postFiles = import.meta.glob('../../content/blog/**/index.md', { eager: true });

  const projects = Object.entries(projectFiles).map(([path, mod]: [string, any]) => ({
    ...mod.frontmatter,
    slug: path.split('/').pop()!.replace('.md', ''),
  }));

  const posts = Object.entries(postFiles).map(([path, mod]: [string, any]) => ({
    ...mod.frontmatter,
    slug: path.split('/').slice(-2, -1)[0],
  }));

  const projectDomains = projects.map((p: any) => p.domain).filter(d => d);
  const postDomains = posts.map((p: any) => p.domain).filter(d => d);
  const uniqueDomains = [...new Set([...projectDomains, ...postDomains])];

  return uniqueDomains.map(domain => ({
    params: { domain },
    props: {
      domain,
      filteredProjects: projects.filter((p: any) => p.domain === domain),
      filteredPosts: posts
        .filter((p: any) => p.domain === domain)
        .sort((a: any, b: any) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()),
    },
  }));
}

const { domain, filteredProjects, filteredPosts } = Astro.props;
const total = filteredProjects.length + filteredPosts.length;
---

<BaseLayout pageTitle={`${domain}`} description={`Content in the ${domain} domain`}>
  <div class="page-header">
    <h1>{domain}</h1>
    <p>{total} {total === 1 ? 'item' : 'items'} in <strong style="color: var(--text-primary);">{domain}</strong></p>
  </div>

  {filteredProjects.length > 0 && (
    <section class="section">
      <p class="section-title">Projects</p>
      <div class="cards-grid">
        {filteredProjects.map((project: any) => (
          <ProjectCard
            title={project.title}
            description={project.description}
            domain={project.domain}
            stack={project.stack}
            slug={project.slug}
            featured={project.featured}
            link={project.link}
          />
        ))}
      </div>
    </section>
  )}

  {filteredPosts.length > 0 && (
    <section class="section">
      <p class="section-title">Blog Posts</p>
      <div class="cards-grid">
        {filteredPosts.map((post: any) => (
          <BlogCard
            title={post.title}
            description={post.description}
            pubDate={post.pubDate}
            domain={post.domain}
            stack={post.stack}
            slug={post.slug}
            author={post.author}
          />
        ))}
      </div>
    </section>
  )}
</BaseLayout>
