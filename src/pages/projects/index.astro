---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import FilterBar from '../../components/FilterBar.astro';

const projectFiles = import.meta.glob('../../content/projects/*.md', { eager: true });

const projects = Object.entries(projectFiles)
  .map(([path, mod]: [string, any]) => ({
    ...mod.frontmatter,
    slug: path.split('/').pop()!.replace('.md', ''),
  }))
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const allDomains = [...new Set(projects.map((p: any) => p.domain ?? ''))].filter(d => d).sort() as string[];
const allStacks = [...new Set(projects.flatMap((p: any) => p.stack ?? []))].sort() as string[];
const allYears = [...new Set(projects.map((p: any) => String(new Date(p.date).getFullYear())))].sort((a, b) => Number(b) - Number(a)) as string[];
---

<BaseLayout pageTitle="Projects" description="A showcase of my software projects.">
  <div class="page-header">
    <h1>Projects</h1>
    <p>Things I've built â€” from open source libraries to production services.</p>
  </div>

  <FilterBar domains={allDomains} stacks={allStacks} years={allYears} />

  <div class="cards-grid">
    {projects.map((project: any) => (
      <div class="card-item" data-domain={project.domain} data-stack={(project.stack ?? []).join(',')} data-year={String(new Date(project.date).getFullYear())}>
        <ProjectCard
          title={project.title}
          description={project.description}
          domain={project.domain}
          stack={project.stack}
          slug={project.slug}
          featured={project.featured}
          link={project.link}
        />
      </div>
    ))}
  </div>
</BaseLayout>
