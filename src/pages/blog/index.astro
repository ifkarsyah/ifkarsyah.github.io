---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import FilterBar from '../../components/FilterBar.astro';

const postEntries = await getCollection('blog');

const posts = postEntries
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

const allTags = [...new Set(posts.flatMap(p => p.data.tags ?? []))].sort() as string[];
const allYears = [...new Set(posts.map(p => String(new Date(p.data.pubDate).getFullYear())))].sort((a, b) => Number(b) - Number(a)) as string[];
---

<BaseLayout pageTitle="Blog" description="Writing about data platform, distributed systems, and machine learning.">
  <div class="page-header">
    <h1>Blog</h1>
    <p>Writing about data platform, distributed systems, and machine learning.</p>
  </div>

  <FilterBar tags={allTags} years={allYears} />

  <div class="cards-grid">
    {posts.map(post => (
      <div class="card-item" data-tags={(post.data.tags ?? []).join(',')} data-year={String(new Date(post.data.pubDate).getFullYear())}>
        <BlogCard
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          tags={post.data.tags}
          slug={post.id.replace('.md', '')}
          image={post.data.image}
        />
      </div>
    ))}
  </div>
</BaseLayout>
